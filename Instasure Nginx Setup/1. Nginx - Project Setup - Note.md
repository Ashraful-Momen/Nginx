# Complete Nginx + Laravel + SSL Setup Guide

## Table of Contents
1. [Prerequisites](#prerequisites)
2. [Laravel Project Upload](#laravel-project-upload)
3. [Nginx Configuration](#nginx-configuration)
4. [SSL Certificate Setup](#ssl-certificate-setup)
5. [Common Issues & Troubleshooting](#common-issues--troubleshooting)
6. [Best Practices](#best-practices)

---

## Prerequisites

### System Requirements
- Ubuntu/Debian server with root/sudo access
- Nginx installed and running
- PHP 7.4+ with PHP-FPM
- Composer installed
- Domain name pointing to your server

### Essential Packages
```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install required packages
sudo apt install nginx php7.4-fpm php7.4-mysql php7.4-xml php7.4-mbstring php7.4-curl php7.4-zip unzip git certbot python3-certbot-nginx -y
```

---

## Laravel Project Upload

### Step 1: Upload Your Laravel Project
```bash
# Create directory for your project
sudo mkdir -p /nginx/your-project-name

# Upload your Laravel project (via Git, FTP, or SCP)
# Example with Git:
cd /nginx/your-project-name
sudo git clone https://github.com/your-username/your-laravel-project.git .

# Or upload via SCP from local machine:
# scp -r /path/to/local/laravel-project user@server:/nginx/your-project-name/
```

### Step 2: Set Proper Permissions
```bash
# Change ownership to nginx user (usually www-data or forge)
sudo chown -R forge:forge /nginx/your-project-name

# Set proper permissions
sudo chmod -R 755 /nginx/your-project-name
sudo chmod -R 775 /nginx/your-project-name/storage
sudo chmod -R 775 /nginx/your-project-name/bootstrap/cache
```

### Step 3: Laravel Configuration
```bash
cd /nginx/your-project-name

# Install dependencies
composer install --optimize-autoloader --no-dev

# Copy environment file
cp .env.example .env

# Generate application key
php artisan key:generate

# Configure your .env file
nano .env
```

**Important .env settings:**
```env
APP_NAME="Your App Name"
APP_ENV=production
APP_DEBUG=false
APP_URL=https://yourdomain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=your_database
DB_USERNAME=your_username
DB_PASSWORD=your_password
```

### Step 4: Database Setup
```bash
# Run migrations
php artisan migrate --force

# Cache configurations for better performance
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

---

## Nginx Configuration

### Step 1: Create Nginx Configuration File
```bash
# Create configuration file
sudo nano /etc/nginx/sites-available/yourdomain.com.conf
```

### Step 2: Basic Nginx Configuration Template
```nginx
# HTTPS Server Block
server {
    listen 443 ssl;
    server_name yourdomain.com www.yourdomain.com;

    # Document root - Always point to Laravel's public folder
    root /nginx/your-project-name/public;
    index index.php index.html index.htm;

    # SSL Certificates (will be added by Certbot)
    # ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    # include /etc/letsencrypt/options-ssl-nginx.conf;
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Increase client max body size for file uploads
    client_max_body_size 100M;
    client_body_timeout 300s;
    client_header_timeout 300s;
    send_timeout 300s;

    # Buffer sizes
    client_body_buffer_size 128k;
    client_header_buffer_size 64k;
    large_client_header_buffers 4 64k;

    # Main location block - Laravel routing
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP handling
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # Additional FastCGI settings for Laravel
        fastcgi_intercept_errors on;
        fastcgi_buffer_size 16k;
        fastcgi_buffers 4 16k;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
    }

    # Deny access to sensitive files
    location ~ /\.ht {
        deny all;
    }
    
    location ~ /\.env {
        deny all;
    }

    # Optional: Static file caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Optional: phpMyAdmin (if needed)
    location /phpmyadmin {
        root /usr/share/;
        index index.php index.html index.htm;
        
        location ~ ^/phpmyadmin/(.+\.php)$ {
            try_files $uri =404;
            root /usr/share/;
            fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include /etc/nginx/fastcgi_params;
        }
        
        location ~* ^/phpmyadmin/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))$ {
            root /usr/share/;
        }
    }
}

# HTTP to HTTPS Redirect
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # Redirect all HTTP requests to HTTPS
    return 301 https://$host$request_uri;
}
```

### Step 3: Enable the Site
```bash
# Create symbolic link to enable the site
sudo ln -s /etc/nginx/sites-available/yourdomain.com.conf /etc/nginx/sites-enabled/

# Test nginx configuration
sudo nginx -t

# If test passes, reload nginx
sudo systemctl reload nginx
```

---

## SSL Certificate Setup

### Step 1: Install SSL Certificate with Certbot
```bash
# Install SSL certificate for your domain
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# Follow the prompts:
# 1. Enter your email address
# 2. Agree to terms of service
# 3. Choose whether to share email with EFF
# 4. Certbot will automatically configure SSL
```

### Step 2: Verify SSL Installation
```bash
# Check certificate status
sudo certbot certificates

# Test automatic renewal
sudo certbot renew --dry-run
```

### Step 3: Auto-renewal Setup (if not already configured)
```bash
# Check if cron job exists
sudo crontab -l

# If not present, add auto-renewal cron job
sudo crontab -e

# Add this line:
0 12 * * * /usr/bin/certbot renew --quiet
```

---

## Common Issues & Troubleshooting

### Issue 1: 502 Bad Gateway
**Cause:** PHP-FPM not running or wrong socket path
```bash
# Check PHP-FPM status
sudo systemctl status php7.4-fpm

# Restart if needed
sudo systemctl restart php7.4-fpm

# Check socket file exists
ls -la /var/run/php/php7.4-fpm.sock
```

### Issue 2: Permission Denied
**Cause:** Wrong file permissions
```bash
# Fix ownership
sudo chown -R forge:forge /nginx/your-project-name

# Fix permissions
sudo chmod -R 755 /nginx/your-project-name
sudo chmod -R 775 /nginx/your-project-name/storage
sudo chmod -R 775 /nginx/your-project-name/bootstrap/cache
```

### Issue 3: Laravel Routes Not Working
**Cause:** Missing `try_files` directive
- Ensure your nginx config has: `try_files $uri $uri/ /index.php?$query_string;`

### Issue 4: File Upload Issues
**Cause:** PHP upload limits too low
```bash
# Edit PHP-FPM config
sudo nano /etc/php/7.4/fpm/php.ini

# Increase these values:
upload_max_filesize = 100M
post_max_size = 100M
max_execution_time = 300
max_input_time = 300

# Restart PHP-FPM
sudo systemctl restart php7.4-fpm
```

### Issue 5: SSL Certificate Errors
```bash
# Check certificate status
sudo certbot certificates

# Renew certificate
sudo certbot renew

# Force renewal
sudo certbot renew --force-renewal
```

---

## Best Practices

### Security
1. **Hide Nginx Version**
   ```nginx
   # Add to main nginx.conf
   server_tokens off;
   ```

2. **Disable Unused HTTP Methods**
   ```nginx
   location / {
       limit_except GET POST HEAD {
           deny all;
       }
       try_files $uri $uri/ /index.php?$query_string;
   }
   ```

3. **Add Security Headers**
   ```nginx
   add_header X-Frame-Options "SAMEORIGIN" always;
   add_header X-XSS-Protection "1; mode=block" always;
   add_header X-Content-Type-Options "nosniff" always;
   add_header Referrer-Policy "no-referrer-when-downgrade" always;
   add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
   ```

### Performance
1. **Enable Gzip Compression**
   ```nginx
   # In main nginx.conf
   gzip on;
   gzip_vary on;
   gzip_proxied any;
   gzip_comp_level 6;
   gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
   ```

2. **Optimize PHP-FPM**
   ```bash
   # Edit PHP-FPM pool config
   sudo nano /etc/php/7.4/fpm/pool.d/www.conf
   
   # Optimize these settings based on your server:
   pm = dynamic
   pm.max_children = 50
   pm.start_servers = 5
   pm.min_spare_servers = 5
   pm.max_spare_servers = 35
   ```

### Monitoring
1. **Log Files Locations**
   - Nginx Access: `/var/log/nginx/access.log`
   - Nginx Error: `/var/log/nginx/error.log`
   - PHP-FPM: `/var/log/php7.4-fpm.log`
   - Laravel: `/nginx/your-project-name/storage/logs/laravel.log`

2. **Regular Maintenance Commands**
   ```bash
   # Clear Laravel cache
   php artisan cache:clear
   php artisan config:clear
   php artisan route:clear
   php artisan view:clear
   
   # Rebuild cache
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```

---

## Quick Deployment Checklist

- [ ] Upload Laravel project to `/nginx/project-name/`
- [ ] Set proper permissions (forge:forge, 755/775)
- [ ] Run `composer install --optimize-autoloader --no-dev`
- [ ] Configure `.env` file
- [ ] Run migrations and cache commands
- [ ] Create nginx configuration file
- [ ] Enable site with symbolic link
- [ ] Test nginx configuration (`nginx -t`)
- [ ] Install SSL certificate with Certbot
- [ ] Verify site is working over HTTPS
- [ ] Set up auto-renewal for SSL certificate

**Remember:** Always backup your configuration files and test changes in a staging environment first!
