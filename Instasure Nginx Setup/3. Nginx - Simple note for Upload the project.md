# Simple Nginx + Laravel + SSL Setup (Line by Line)

## üìã Prerequisites Setup

### Install Required Packages
```bash
# Update system packages to latest versions
sudo apt update && sudo apt upgrade -y

# Install nginx web server
sudo apt install nginx -y

# Install PHP 7.4 and required extensions for Laravel
sudo apt install php7.4-fpm php7.4-mysql php7.4-xml php7.4-mbstring php7.4-curl php7.4-zip -y

# Install Certbot for SSL certificates from Let's Encrypt
sudo apt install certbot python3-certbot-nginx -y

# Install Composer (PHP package manager) for Laravel dependencies
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
```

---

## üìÅ Step 1: Upload Laravel Project

### Create Project Directory
```bash
# Create a directory to store your Laravel project
sudo mkdir -p /var/www/myproject

# Navigate to the project directory
cd /var/www/myproject

# Clone your Laravel project from Git repository
sudo git clone https://github.com/username/your-laravel-project.git .

# Alternative: Upload via SCP if you have project locally
# scp -r /local/path/to/laravel-project user@server:/var/www/myproject/
```

### Set Proper Permissions
```bash
# Change ownership of all files to the web server user (www-data)
sudo chown -R www-data:www-data /var/www/myproject

# Set read/write/execute permissions for directories (755 = rwxr-xr-x)
sudo find /var/www/myproject -type d -exec chmod 755 {} \;

# Set read/write permissions for files (644 = rw-r--r--)
sudo find /var/www/myproject -type f -exec chmod 644 {} \;

# Give special write permissions to Laravel storage and cache directories
sudo chmod -R 775 /var/www/myproject/storage
sudo chmod -R 775 /var/www/myproject/bootstrap/cache
```

### Configure Laravel
```bash
# Install Laravel dependencies using Composer
composer install --optimize-autoloader --no-dev

# Copy environment example file to create actual environment file
cp .env.example .env

# Generate unique application key for Laravel security
php artisan key:generate

# Edit environment file to configure database and app settings
nano .env
```

**Basic .env Configuration:**
```env
# Application name that will appear in your app
APP_NAME="My Laravel App"

# Set to production for live sites (hides debug info)
APP_ENV=production

# Set to false for security (never show errors to users)
APP_DEBUG=false

# Your website URL (will be HTTPS after SSL setup)
APP_URL=https://myproject.com

# Database connection settings
DB_CONNECTION=mysql          # Type of database (MySQL)
DB_HOST=127.0.0.1           # Database server location (local)
DB_PORT=3306                # MySQL default port
DB_DATABASE=myproject_db    # Name of your database
DB_USERNAME=db_user         # Database username
DB_PASSWORD=secure_password # Database password
```

### Run Laravel Setup Commands
```bash
# Run database migrations to create tables
php artisan migrate --force

# Cache configuration files for better performance
php artisan config:cache

# Cache routes for faster routing
php artisan route:cache

# Cache compiled views for faster page loads
php artisan view:cache
```

---

## ‚öôÔ∏è Step 2: Create Nginx Configuration

### Create Configuration File
```bash
# Create a new Nginx configuration file for your site
sudo nano /etc/nginx/sites-available/myproject.com
```

### Complete Nginx Configuration (Line by Line)
```nginx
# ================================
# HTTPS SERVER BLOCK (Main Site)
# ================================

server {
    # Listen on port 443 for HTTPS traffic with SSL enabled
    listen 443 ssl;
    
    # Listen on IPv6 port 443 for HTTPS traffic
    listen [::]:443 ssl;
    
    # Domain names this server block will respond to
    server_name myproject.com www.myproject.com;
    
    # Root directory pointing to Laravel's public folder (IMPORTANT: Always /public)
    root /var/www/myproject/public;
    
    # Default files to serve when accessing a directory
    index index.php index.html index.htm;

    # ================================
    # SSL CERTIFICATE CONFIGURATION
    # ================================
    
    # Path to SSL certificate (will be auto-added by Certbot)
    ssl_certificate /etc/letsencrypt/live/myproject.com/fullchain.pem;
    
    # Path to SSL private key (will be auto-added by Certbot)
    ssl_certificate_key /etc/letsencrypt/live/myproject.com/privkey.pem;
    
    # Include recommended SSL settings from Let's Encrypt
    include /etc/letsencrypt/options-ssl-nginx.conf;
    
    # Path to Diffie-Hellman parameters for stronger SSL security
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # ================================
    # FILE UPLOAD SETTINGS
    # ================================
    
    # Maximum size of uploaded files (100MB)
    client_max_body_size 100M;
    
    # Timeout for receiving client request body
    client_body_timeout 300s;
    
    # Timeout for receiving client request headers
    client_header_timeout 300s;
    
    # Timeout for sending response to client
    send_timeout 300s;

    # ================================
    # LARAVEL ROUTING (MOST IMPORTANT)
    # ================================
    
    location / {
        # Try to serve request as file, then as directory, then send to Laravel router
        # This makes Laravel routing work properly
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ================================
    # PHP PROCESSING
    # ================================
    
    # Handle all .php files through PHP-FPM
    location ~ \.php$ {
        # Include standard FastCGI settings for PHP
        include snippets/fastcgi-php.conf;
        
        # Send PHP requests to PHP-FPM socket (faster than TCP)
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        
        # Tell PHP-FPM the exact file path to execute
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # Include all standard FastCGI parameters
        include fastcgi_params;
        
        # Don't show PHP version in headers (security)
        fastcgi_hide_header X-Powered-By;
        
        # Increase timeouts for slow PHP scripts
        fastcgi_read_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
    }

    # ================================
    # SECURITY RULES
    # ================================
    
    # Block access to .htaccess files (Apache config files)
    location ~ /\.ht {
        deny all;
    }
    
    # Block access to .env files (contains sensitive data)
    location ~ /\.env {
        deny all;
    }
    
    # Block access to any .git files (source control)
    location ~ /\.git {
        deny all;
    }
    
    # Block direct access to storage folder (Laravel files)
    location ~ ^/storage/.*\.php$ {
        deny all;
    }

    # ================================
    # PERFORMANCE OPTIMIZATION
    # ================================
    
    # Cache static files for 1 year with immutable flag
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        # Don't log static file requests (reduces log size)
        access_log off;
    }

    # ================================
    # SECURITY HEADERS
    # ================================
    
    # Prevent page from being embedded in frames (clickjacking protection)
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Enable XSS filtering in browsers
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Control how much referrer information is passed
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}

# ================================
# HTTP TO HTTPS REDIRECT SERVER
# ================================

server {
    # Listen on port 80 for HTTP traffic
    listen 80;
    
    # Listen on IPv6 port 80 for HTTP traffic
    listen [::]:80;
    
    # Domain names this redirect applies to
    server_name myproject.com www.myproject.com;
    
    # Permanently redirect all HTTP requests to HTTPS
    # $host = the domain name, $request_uri = the path and query string
    return 301 https://$host$request_uri;
}
```

---

## üîó Step 3: Enable the Site

### Create Symbolic Link
```bash
# Create a symbolic link from sites-available to sites-enabled
# This tells Nginx to load this configuration
sudo ln -s /etc/nginx/sites-available/myproject.com /etc/nginx/sites-enabled/

# Test Nginx configuration for syntax errors
sudo nginx -t

# If test passes, reload Nginx to apply new configuration
sudo systemctl reload nginx
```

### Check Service Status
```bash
# Check if Nginx is running properly
sudo systemctl status nginx

# Check if PHP-FPM is running properly
sudo systemctl status php7.4-fpm

# If either service is not running, start them
sudo systemctl start nginx
sudo systemctl start php7.4-fpm
```

---

## üîí Step 4: Install SSL Certificate

### Run Certbot for SSL
```bash
# Install SSL certificate for your domain using Certbot
# -d flag specifies domains to include in certificate
sudo certbot --nginx -d myproject.com -d www.myproject.com
```

**Certbot will ask you:**
1. **Email address** - For renewal notifications and urgent notices
2. **Terms of Service** - Type 'A' to agree
3. **Share email with EFF** - Type 'Y' or 'N' (your choice)

### Verify SSL Installation
```bash
# Check all certificates managed by Certbot
sudo certbot certificates

# Test automatic renewal (doesn't actually renew)
sudo certbot renew --dry-run

# Check if auto-renewal cron job exists
sudo crontab -l
```

### Setup Auto-Renewal (if needed)
```bash
# Edit root's cron jobs
sudo crontab -e

# Add this line to automatically renew certificates daily at noon
# 0 12 * * * = Run at 12:00 PM every day
# --quiet = Don't output anything unless there's an error
0 12 * * * /usr/bin/certbot renew --quiet
```

---

## ‚úÖ Step 5: Final Verification

### Test Your Site
```bash
# Test HTTP redirect (should redirect to HTTPS)
curl -I http://myproject.com

# Test HTTPS response (should return 200 OK)
curl -I https://myproject.com

# Check SSL certificate details
openssl s_client -connect myproject.com:443 -servername myproject.com
```

### Check Log Files
```bash
# View Nginx access logs (successful requests)
sudo tail -f /var/log/nginx/access.log

# View Nginx error logs (errors and warnings)
sudo tail -f /var/log/nginx/error.log

# View PHP-FPM logs (PHP errors)
sudo tail -f /var/log/php7.4-fpm.log

# View Laravel application logs
tail -f /var/www/myproject/storage/logs/laravel.log
```

---

## üö® Common Issues & Solutions

### 502 Bad Gateway Error
```bash
# Usually means PHP-FPM is not running
sudo systemctl restart php7.4-fpm

# Or wrong socket path in Nginx config
# Check if socket file exists:
ls -la /var/run/php/php7.4-fpm.sock
```

### 403 Forbidden Error
```bash
# Usually permission problems
sudo chown -R www-data:www-data /var/www/myproject
sudo chmod -R 755 /var/www/myproject
```

### Laravel 500 Error
```bash
# Clear all Laravel caches
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear

# Check storage permissions
sudo chmod -R 775 /var/www/myproject/storage
sudo chmod -R 775 /var/www/myproject/bootstrap/cache
```

### SSL Certificate Issues
```bash
# Force renew certificate
sudo certbot renew --force-renewal

# Or reinstall certificate
sudo certbot --nginx -d myproject.com -d www.myproject.com --force-renewal
```

---

## üìù Quick Reference Commands

```bash
# Restart all services
sudo systemctl restart nginx php7.4-fpm

# Reload Nginx configuration (no downtime)
sudo systemctl reload nginx

# Test Nginx configuration
sudo nginx -t

# View real-time logs
sudo tail -f /var/log/nginx/error.log

# Laravel cache rebuild
php artisan config:cache && php artisan route:cache && php artisan view:cache
```

**üéØ Remember:** Always point Nginx `root` to Laravel's `/public` directory, never to the Laravel root directory!
